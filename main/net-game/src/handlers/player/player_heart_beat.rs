use crate::utils::time;
use net_msg::pb::{PlayerHeartBeatCsReq, PlayerHeartBeatScRsp, ClientDownloadData};
use net_msg::{dec, Trait};
use rbase64;

pub async fn handle(req: &[u8]) -> Vec<u8> {
    let req = dec!(PlayerHeartBeatCsReq, req);

    PlayerHeartBeatScRsp {
        download_data: Some(ClientDownloadData {
            version: 51,
            time: time::cur_timestamp_ms() as i64,
            data: rbase64::decode("bG9jYWwgZnVuY3Rpb24gYmV0YV90ZXh0KCkKICAgIGxvY2FsIGdhbWVPYmplY3QgPSBDUy5Vbml0eUVuZ2luZS5HYW1lT2JqZWN0LkZpbmQoIlVJUm9vdC9BYm92ZURpYWxvZy9CZXRhSGludERpYWxvZyhDbG9uZSkiKQogICAgZ2FtZU9iamVjdC50cmFuc2Zvcm0ubG9jYWxQb3NpdGlvbiA9IENTLlVuaXR5RW5naW5lLlZlY3RvcjMoLTEwLCAxMCwgMCkKICAgIGlmIGdhbWVPYmplY3QgdGhlbgogICAgICAgIGxvY2FsIHRleHRDb21wb25lbnQgPSBnYW1lT2JqZWN0OkdldENvbXBvbmVudEluQ2hpbGRyZW4odHlwZW9mKENTLlJQRy5DbGllbnQuTG9jYWxpemVkVGV4dCkpCiAgICAgICAgaWYgdGV4dENvbXBvbmVudCB0aGVuCiAgICAgICAgICAgIHVpZCA9IHRleHRDb21wb25lbnQudGV4dDsKICAgICAgICAgICAgdGV4dENvbXBvbmVudC50ZXh0ID0gJzxzaXplPTE2Pjxjb2xvcj0jMzg5NWI3Pkc8L2NvbG9yPjxjb2xvcj0jNWI5OGJkPmE8L2NvbG9yPjxjb2xvcj0jN2Y5YmMzPnQ8L2NvbG9yPjxjb2xvcj0jYTI5ZGM5Pm88L2NvbG9yPjxjb2xvcj0jYzZhMGNmPlM8L2NvbG9yPjxjb2xvcj0jZTlhM2Q1PlI8L2NvbG9yPjxjb2xvcj0jRkY1Q0NCPiBMPC9jb2xvcj48Y29sb3I9I0ZGNDVEMj5pPC9jb2xvcj48Y29sb3I9I0ZGMkVEQT50PC9jb2xvcj48Y29sb3I9I0ZGMTdFMj5lPC9jb2xvcj48L3NpemU+JwogICAgICAgIGVuZAogICAgZW5kCmVuZAoKbG9jYWwgZnVuY3Rpb24gdmVyc2lvbl90ZXh0KCkKICAgIGxvY2FsIGdhbWVPYmplY3QgPSBDUy5Vbml0eUVuZ2luZS5HYW1lT2JqZWN0LkZpbmQoIlZlcnNpb25UZXh0IikKICAgIGlmIGdhbWVPYmplY3QgdGhlbgogICAgICAgIGxvY2FsIHRleHRDb21wb25lbnQgPSBnYW1lT2JqZWN0OkdldENvbXBvbmVudEluQ2hpbGRyZW4odHlwZW9mKENTLlJQRy5DbGllbnQuTG9jYWxpemVkVGV4dCkpCiAgICAgICAgaWYgdGV4dENvbXBvbmVudCB0aGVuCiAgICAgICAgICAgIHRleHRDb21wb25lbnQudGV4dCA9ICc8c2l6ZT0xMj48Y29sb3I9IzM4OTVCNz5kPC9jb2xvcj48Y29sb3I9IzNFOTVCOD5pPC9jb2xvcj48Y29sb3I9IzQ0OTVCOT5zPC9jb2xvcj48Y29sb3I9IzRBOTZCQT5jPC9jb2xvcj48Y29sb3I9IzUwOTZCQj5vPC9jb2xvcj48Y29sb3I9IzU2OTdCQz5yPC9jb2xvcj48Y29sb3I9IzVDOTdCRD5kPC9jb2xvcj48Y29sb3I9IzYyOThCRT4uPC9jb2xvcj48Y29sb3I9IzY4OThCRj5jPC9jb2xvcj48Y29sb3I9IzZFOTlDMD5vPC9jb2xvcj48Y29sb3I9Izc1OTlDMT5tPC9jb2xvcj48Y29sb3I9IzdCOUFDMj4vPC9jb2xvcj48Y29sb3I9IzgxOUFDMz5pPC9jb2xvcj48Y29sb3I9Izg3OUJDND5uPC9jb2xvcj48Y29sb3I9IzhEOUJDNT52PC9jb2xvcj48Y29sb3I9IzkzOUNDNj5pPC9jb2xvcj48Y29sb3I9Izk5OUNDNz50PC9jb2xvcj48Y29sb3I9IzlGOURDOD5lPC9jb2xvcj48Y29sb3I9I0E1OURDOT4vPC9jb2xvcj48Y29sb3I9I0FCOUVDQT5oPC9jb2xvcj48Y29sb3I9I0IyOUVDQj5BPC9jb2xvcj48Y29sb3I9I0I4OUZDQz5DPC9jb2xvcj48Y29sb3I9I0JFOUZDRD40PC9jb2xvcj48Y29sb3I9I0M0QTBDRT43PC9jb2xvcj48Y29sb3I9I0NBQTBDRj5uPC9jb2xvcj48Y29sb3I9I0QwQTFEMD5VPC9jb2xvcj48Y29sb3I9I0Q2QTFEMT5BPC9jb2xvcj48Y29sb3I9I0RDQTJEMj5xPC9jb2xvcj48Y29sb3I9I0UyQTJEMz5OPC9jb2xvcj48L3NpemU+JwogICAgICAgIGVuZAogICAgZW5kCmVuZAoKbG9jYWwgZnVuY3Rpb24gbWh5X3RleHQob2JqKQogICAgbG9jYWwgZ2FtZU9iamVjdCA9IENTLlVuaXR5RW5naW5lLkdhbWVPYmplY3QuRmluZCgiSURNQVAxIikKICAgIGlmIGdhbWVPYmplY3QgdGhlbgogICAgICAgIGxvY2FsIHRleHRDb21wb25lbnQgPSBnYW1lT2JqZWN0OkdldENvbXBvbmVudEluQ2hpbGRyZW4odHlwZW9mKENTLlJQRy5DbGllbnQuTWVzc2FnZUJveERpYWxvZ1V0aWwpKQogICAgICAgIGlmIHRleHRDb21wb25lbnQgdGhlbgogICAgICAgICAgICB0ZXh0Q29tcG9uZW50LlNob3dBYm92ZURpYWxvZ1RleHQgPSBmYWxzZQogICAgICAgIGVuZAogICAgZW5kCmVuZAoKdmVyc2lvbl90ZXh0KCkKYmV0YV90ZXh0KCkKbWh5X3RleHQoKQ==").unwrap()
        }),
        client_time_ms: req.client_time_ms,
        server_time_ms: time::cur_timestamp_ms(),
        retcode: 0,
    }
    .encode_to_vec()
}